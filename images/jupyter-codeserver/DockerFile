FROM jupyter/pytorch-notebook

USER root
ENV HOME="/config"

# 安装必要的依赖
RUN apt-get update && apt-get install -y \
    curl \
    git \
    zip \
    unzip \
    && apt-get clean \
    echo "**** install code-server ****" && \
    if [ -z ${CODE_RELEASE+x} ]; then \
        CODE_RELEASE=$(curl -sX GET https://api.github.com/repos/coder/code-server/releases/latest \
          | awk '/tag_name/{print $4;exit}' FS='[""]' | sed 's|^v||'); \
    fi && \
    mkdir -p /app/code-server && \
    curl -o \
        /tmp/code-server.tar.gz -L \
        "https://github.com/coder/code-server/releases/download/v${CODE_RELEASE}/code-server-${CODE_RELEASE}-linux-amd64.tar.gz" && \
    tar xf /tmp/code-server.tar.gz -C \
        /app/code-server --strip-components=1 && \


# 安装Code-Server
#RUN curl -fsSL https://code-server.dev/install.sh | sh

# 暴露端口
EXPOSE 8888 8080

USER $NB_UID

# 启动脚本
COPY ./images/jupyter-codeserver/startcode-server.sh /usr/local/bin/

USER root

RUN chmod +x /usr/local/bin/startcode-server.sh
USER $NB_UID

CMD ["/usr/local/bin/startcode-server.sh"]
